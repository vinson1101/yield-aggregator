#!/usr/bin/env npx tsx
/**
 * Yield Aggregator - 使用 CDP Smart Account 自动切换收益协议
 */

import { CdpClient } from '@coinbase/cdp-sdk';
import { createPublicClient, http, parseAbi, encodeFunctionData } from 'viem';
import { base } from 'viem/chains';
import dotenv from 'dotenv';

dotenv.config({ path: '/root/.openclaw/workspace/base-trading-framework/.env.cdp' });

// 配置
const SMART_ACCOUNT = '0x5Bae0994344d22E0a3377e81204CC7c030c65e96';
const EOA_ACCOUNT = '0x1758DE3E2cf746F4eEb7143c3935fCa1B30060ce';

// 协议地址
const USDC = '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913';
const AAVE_POOL = '0xa238dd80c259a72e81d7e4664a9801593f98d1c5';
const AAVE_ATOKEN = '0x4e65fe4dba92790696d040ac24aa414708f5c0ab';
const MORPHO_VAULT = '0xc1256Ae5FF1cf2719D4937adb3bbCCab2E00A2Ca';

// 利率 (简化: 实际应该从合约查询)
const AAVE_APY = 0.035; // 3.5%
const MORPHO_APY = 0.098; // 9.8%

const ERC20_ABI = parseAbi([
  'function approve(address spender, uint256 amount) returns (bool)',
  'function balanceOf(address owner) view returns (uint256)',
  'function allowance(address owner, address spender) view returns (uint256)'
]);

const AAVE_ABI = parseAbi([
  'function supply(address asset, uint256 amount, address onBehalfOf, uint16 referralCode)',
  'function withdraw(address asset, uint256 amount, address to)',
]);

const MORPHO_ABI = parseAbi([
  'function deposit(uint256 assets, address receiver) returns (uint256)',
  'function withdraw(uint256 assets, address receiver, address owner) returns (uint256)',
]);

async function main() {
  const action = process.argv[2] || 'check';
  
  const cdp = new CdpClient({
    apiKeyId: process.env.CDP_API_KEY_ID,
    apiKeySecret: process.env.CDP_API_KEY_SECRET,
  });

  const publicClient = createPublicClient({ chain: base, transport: http('https://mainnet.base.org') });

  console.log('=== Yield Aggregator (CDP Smart Account) ===\n');

  // 1. 获取 Smart Account 余额
  const usdcBalance = await publicClient.readContract({
    address: USDC, abi: ERC20_ABI, functionName: 'balanceOf', args: [SMART_ACCOUNT]
  });

  const aaveBalance = await publicClient.readContract({
    address: AAVE_ATOKEN, abi: ERC20_ABI, functionName: 'balanceOf', args: [SMART_ACCOUNT]
  });

  // Morpho 余额查询
  let morphoBalance = 0n;
  try {
    const morphoShares = await publicClient.readContract({
      address: MORPHO_VAULT, abi: parseAbi(['function balanceOf(address) view returns (uint256)']), 
      functionName: 'balanceOf', args: [SMART_ACCOUNT]
    });
    if (morphoShares > 0n) {
      morphoBalance = await publicClient.readContract({
        address: MORPHO_VAULT, abi: parseAbi(['function convertToAssets(uint256 shares) view returns (uint256)']),
        functionName: 'convertToAssets', args: [morphoShares]
      });
    }
  } catch (e) {
    // Morpho 可能没有 balanceOf
  }

  console.log('📊 当前状态:');
  console.log(`  Wallet USDC: ${Number(usdcBalance) / 1e6}`);
  console.log(`  Aave aUSDC:  ${Number(aaveBalance) / 1e6} (APY: ${AAVE_APY * 100}%)`);
  console.log(`  Morpho:     ${Number(morphoBalance) / 1e6} (APY: ${MORPHO_APY * 100}%)\n`);

  if (action === 'check') {
    const totalAave = Number(aaveBalance) / 1e6;
    const totalMorpho = Number(morphoBalance) / 1e6;
    const totalUSDC = Number(usdcBalance) / 1e6;
    
    console.log('📈 收益比较:');
    console.log(`  Aave:   ${AAVE_APY * 100}% APY (当前: ${totalAave} USDC)`);
    console.log(`  Morpho: ${MORPHO_APY * 100}% APY (当前: ${totalMorpho} USDC)\n`);
    
    if (totalMorpho > 0 && totalAave > 0) {
      if (MORPHO_APY > AAVE_APY && totalMorpho < totalAave) {
        console.log(`🎯 建议: 把 ${totalAave} USDC 从 Aave 转到 Morpho (多赚 ${(MORPHO_APY - AAVE_APY) * 100}%)`);
      } else if (AAVE_APY > MORPHO_APY && totalMorpho > totalAave) {
        console.log(`🎯 建议: 把 ${totalMorpho} USDC 从 Morpho 转到 Aave`);
      } else {
        console.log('💤 当前已是最高收益协议');
      }
    } else if (totalAave > 0 && totalMorpho === 0) {
      console.log(`🎯 建议: 把 USDC 从 Aave 转到 Morpho (多赚 ${(MORPHO_APY - AAVE_APY) * 100}%)`);
      console.log(`   当前 Aave: ${totalAave} USDC → Morpho: ${totalAave * MORPHO_APY / AAVE_APY} USDC (等价)`);
    } else if (totalUSDC > 0) {
      console.log(`🎯 建议: 存入 Morpho (${MORPHO_APY * 100}%) 而非 Aave (${AAVE_APY * 100}%)`);
    } else {
      console.log('💤 无资金需要配置');
    }
    return;
  }

  if (action === 'switch') {
    console.log('⚠️ 切换功能需要 CDP SDK 执行复杂交易');
    console.log('   目前手动操作:');
    console.log('   1. 从 Aave 取款到 Smart Account');
    console.log('   2. 存入 Morpho');
    console.log('\n💡 或者把 USDC 转到 EOA (0x1758) 用私钥操作');
  }
}

main().catch(console.error);
